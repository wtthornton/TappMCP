<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Graph Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            margin: 20px 0;
        }
        .btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #00f2fe;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status-success { background: #10b981; color: white; }
        .status-error { background: #ef4444; color: white; }
        .status-info { background: #3b82f6; color: white; }

        .node {
            cursor: pointer;
        }
        .node circle {
            fill: #4facfe;
            stroke: #ffffff;
            stroke-width: 2px;
            transition: all 0.3s ease;
        }
        .node text {
            fill: #ffffff;
            font-size: 12px;
            font-weight: 500;
            text-anchor: middle;
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: #666;
            stroke-width: 2px;
            stroke-opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß D3.js Graph Fix Test</h1>

        <div class="test-section">
            <h2>Test Controls</h2>
            <button class="btn" onclick="testD3Import()">Test D3 Import</button>
            <button class="btn" onclick="testGraphRendering()">Test Graph Rendering</button>
            <button class="btn" onclick="testInteractions()">Test Interactions</button>
            <button class="btn" onclick="clearTest()">Clear Test</button>
        </div>

        <div class="test-section">
            <h2>Test Results</h2>
            <div id="testResults" class="status status-info">Click a test button to see results...</div>
        </div>

        <div class="test-section">
            <h2>D3.js Graph Test</h2>
            <div class="chart-container" id="test-graph"></div>
        </div>
    </div>

    <script type="module">
        let d3;
        let testGraph;

        // Test D3.js import
        async function testD3Import() {
            const results = document.getElementById('testResults');
            results.className = 'status status-info';
            results.textContent = 'Testing D3.js import...';

            try {
                // Import D3.js
                d3 = await import('https://unpkg.com/d3@7/dist/d3.min.js');
                window.d3 = d3;

                results.className = 'status status-success';
                results.textContent = '‚úÖ D3.js imported successfully! Version: ' + d3.version;
                console.log('D3.js loaded:', d3);
            } catch (error) {
                results.className = 'status status-error';
                results.textContent = '‚ùå D3.js import failed: ' + error.message;
                console.error('D3.js import error:', error);
            }
        }

        // Test graph rendering
        function testGraphRendering() {
            const results = document.getElementById('testResults');

            if (!d3) {
                results.className = 'status status-error';
                results.textContent = '‚ùå D3.js not loaded. Click "Test D3 Import" first.';
                return;
            }

            results.className = 'status status-info';
            results.textContent = 'Testing graph rendering...';

            try {
                const container = d3.select('#test-graph');

                // Clear previous content
                container.selectAll('*').remove();

                // Create SVG
                const svg = container.append('svg')
                    .attr('width', 800)
                    .attr('height', 400);

                // Test data
                const nodes = [
                    { id: 'start', name: 'Start', x: 100, y: 200, status: 'active' },
                    { id: 'process', name: 'Process', x: 300, y: 200, status: 'pending' },
                    { id: 'analyze', name: 'Analyze', x: 500, y: 200, status: 'pending' },
                    { id: 'end', name: 'End', x: 700, y: 200, status: 'completed' }
                ];

                const links = [
                    { source: 'start', target: 'process' },
                    { source: 'process', target: 'analyze' },
                    { source: 'analyze', target: 'end' }
                ];

                // Draw links
                svg.selectAll('.link')
                    .data(links)
                    .enter()
                    .append('line')
                    .attr('class', 'link')
                    .attr('x1', d => nodes.find(n => n.id === d.source).x)
                    .attr('y1', d => nodes.find(n => n.id === d.source).y)
                    .attr('x2', d => nodes.find(n => n.id === d.target).x)
                    .attr('y2', d => nodes.find(n => n.id === d.target).y);

                // Draw nodes
                const nodeGroups = svg.selectAll('.node')
                    .data(nodes)
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.x},${d.y})`);

                nodeGroups.append('circle')
                    .attr('r', 30)
                    .attr('class', d => `node-${d.status}`)
                    .on('click', (event, d) => {
                        console.log('Clicked node:', d.name);
                        alert(`Clicked node: ${d.name} (${d.status})`);
                    });

                nodeGroups.append('text')
                    .text(d => d.name)
                    .attr('dy', 5);

                results.className = 'status status-success';
                results.textContent = '‚úÖ Graph rendered successfully! Click on nodes to test interactions.';

                testGraph = { svg, nodes, links };
                console.log('Graph rendered successfully');
            } catch (error) {
                results.className = 'status status-error';
                results.textContent = '‚ùå Graph rendering failed: ' + error.message;
                console.error('Graph rendering error:', error);
            }
        }

        // Test interactions
        function testInteractions() {
            const results = document.getElementById('testResults');

            if (!testGraph) {
                results.className = 'status status-error';
                results.textContent = '‚ùå No graph to test. Click "Test Graph Rendering" first.';
                return;
            }

            results.className = 'status status-info';
            results.textContent = 'Testing interactions...';

            try {
                // Add zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 10])
                    .on('zoom', (event) => {
                        testGraph.svg.selectAll('.node, .link')
                            .attr('transform', event.transform);
                    });

                testGraph.svg.call(zoom);

                // Add drag behavior to nodes
                const drag = d3.drag()
                    .on('start', function(event, d) {
                        console.log('Drag started on:', d.name);
                    })
                    .on('drag', function(event, d) {
                        d.x = event.x;
                        d.y = event.y;
                        d3.select(this).attr('transform', `translate(${d.x},${d.y})`);
                    })
                    .on('end', function(event, d) {
                        console.log('Drag ended on:', d.name);
                    });

                testGraph.svg.selectAll('.node').call(drag);

                results.className = 'status status-success';
                results.textContent = '‚úÖ Interactions added! Try zooming and dragging nodes.';
                console.log('Interactions added successfully');
            } catch (error) {
                results.className = 'status status-error';
                results.textContent = '‚ùå Interaction setup failed: ' + error.message;
                console.error('Interaction setup error:', error);
            }
        }

        // Clear test
        function clearTest() {
            const results = document.getElementById('testResults');
            const container = document.getElementById('test-graph');

            container.innerHTML = '';
            results.className = 'status status-info';
            results.textContent = 'Test cleared. Ready for new tests.';

            d3 = null;
            testGraph = null;
        }

        // Make functions globally available
        window.testD3Import = testD3Import;
        window.testGraphRendering = testGraphRendering;
        window.testInteractions = testInteractions;
        window.clearTest = clearTest;

        console.log('üîß D3.js Graph Fix Test loaded');
    </script>
</body>
</html>
